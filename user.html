<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Usuarios</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <!-- script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script -->
    <script>
        const API_URL = "https://api.jsonbin.io/v3/b/67a55304e41b4d34e4856689";
        const API_KEY = "$2a$10$8po/OflSVO.7wKFgq9ITgeHx9Q.efzaedXbtwedUL6ICY616r6bGG";
        let users = [];
        let editIndex = null;

        $(document).ready(function () {
            loadUsers();
            $("#statusFilter").on("change", filterUsers);
            $("#saveBtn").on("click", saveUser);
        });

        function loadUsers() {
            $.ajax({
                url: API_URL + "/latest",
                headers: { "X-MASTER-KEY": API_KEY },
                type: "GET",
                success: function (response) {
                    users = Array.isArray(response.record) ? response.record : [];
                    renderTable(users);
                }
            });
        }

        function renderTable(data) {
            let rows = "";
            data.forEach((user, index) => {
                rows += `<tr>
                <td><input type='checkbox' id='${user.id}' /></td>
                    <td>${user.id}</td>
                    <td>${user.name}</td>
                    <td>${user.last_name}</td>
                    <td>${user.age}</td>
                    <td>${user.gender}</td>
                    <td>${user.data1}</td>
                    <td>${user.data2}</td>
                    <td>${user.status}</td>
                    <td>
                        <a href='#' class='text-warning' onclick='editUser(${index})'><i class='fa fa-2x fa-pencil-square-o' aria-hidden='true'></i></a> &nbsp; &nbsp;
                        <a href='#' class='text-danger' onclick='deleteUser(${index})'><i class='fa fa-2x fa-trash-o' aria-hidden='true'></i></a>
                    </td>
                </tr>`;
            });
            $("#userTable tbody").html(rows);
        }

        function filterUsers() {
            const status = parseInt($("#statusFilter").val());
            const filteredUsers = isNaN(status) ? users : users.filter(user => user.status === status);
            renderTable(filteredUsers);
        }

        function sortTable(column) {
            users.sort((a, b) => (a[column] > b[column]) ? 1 : -1);
            renderTable(users);
        }

        function saveUsers() {
            $.ajax({
                url: API_URL,
                headers: { "X-MASTER-KEY": API_KEY, "Content-Type": "application/json" },
                type: "PUT",
                data: JSON.stringify(users),
                success: function () { loadUsers(); }
            });
        }

        function saveUser() {
            const user = {
                id: editIndex !== null ? users[editIndex].id : users.length + 1,
                name: $("#name").val(),
                last_name: $("#last_name").val(),
                age: parseInt($("#age").val()),
                gender: $("#gender").val(),
                data1: parseInt($("#data1").val()),
                data2: parseInt($("#data2").val()),
                status: parseInt($("#status").val())
            };
            
            if (editIndex !== null) {
                users[editIndex] = user;
                editIndex = null;
            } else {
                users.push(user);
            }
            saveUsers();
            $("#saveBtn").html('<i class="fas fa-save"></i>');
            $("input").val("");
        }

        function editUser(index) {
            const user = users[index];
            $("#name").val(user.name);
            $("#last_name").val(user.last_name);
            $("#age").val(user.age);
            $("#gender").val(user.gender);
            $("#data1").val(user.data1);
            $("#data2").val(user.data2);
            $("#status").val(user.status);
            editIndex = index;
            $("#saveBtn").html('<i class="fas fa-edit"></i>');
        }

        function deleteUser(index) {
            users.splice(index, 1);
            saveUsers();
        }
    </script>
</head>
<body class="container">
    <h2 class="mt-3">Gestión de Usuarios</h2>
    <div class="mb-3">
        <label for="statusFilter" class="form-label">Filtrar por Estado:</label>
        <select id="statusFilter" class="form-control">
            <option value="">Todos</option>
            <option value="0">0</option>
            <option value="1">1</option>
            <option value="2">2</option>
        </select>
    </div>
    <table class="table table-bordered table-condensed" id="userTable">
        <thead>
            <tr>
                <th>*</th>
                <th onclick="sortTable('id')">ID</th>
                <th onclick="sortTable('name')">Nombre</th>
                <th onclick="sortTable('last_name')">Apellido</th>
                <th onclick="sortTable('age')">Edad</th>
                <th onclick="sortTable('gender')">Género</th>
                <th onclick="sortTable('data1')">50m</th>
                <th onclick="sortTable('data2')">100m</th>
                <th onclick="sortTable('status')">status</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <h3>Añadir/Editar Usuario</h3>
    <div class="row">
        <div class="col"><input type="text" id="name" class="form-control" placeholder="Nombre"></div>
        <div class="col"><input type="text" id="last_name" class="form-control" placeholder="Apellido"></div>
        <div class="col"><input type="number" id="age" class="form-control" placeholder="Edad"></div>
        <div class="col"><input type="text" id="gender" class="form-control" placeholder="Género"></div>
        <div class="col"><input type="number" id="data1" class="form-control" placeholder="50m"></div>
        <div class="col"><input type="number" id="data2" class="form-control" placeholder="100m"></div>
        <div class="col"><input type="number" id="status" class="form-control" placeholder="status"></div>
        <div class="col"><a href="#" class="text-success" id="saveBtn"><i class='fa fa-2x fa-floppy-o' aria-hidden='true'></i></a></div>
    </div>
</body>
</html>
